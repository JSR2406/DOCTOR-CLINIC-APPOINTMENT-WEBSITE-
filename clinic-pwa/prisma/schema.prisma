generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String         @id @default(cuid())
  name                    String
  email                   String         @unique
  phone                   String         @unique
  phoneVerified           Boolean        @default(false)
  password                String?
  role                    UserRole       @default(PATIENT)
  avatar                  String?
  dateOfBirth             DateTime?
  gender                  Gender?
  address                 String?
  city                    String?
  state                   String?
  pincode                 String?
  emergencyContact        String?
  medicalHistory          String?
  oneSignalId             String?        @unique
  notificationPreferences Json?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt

  appointments   Appointment[]
  notifications  Notification[]
  prescriptions  Prescription[]
  medicalReports MedicalReport[]
  chatHistory    ChatMessage[]

  @@index([email])
  @@index([phone])
}

enum UserRole {
  PATIENT
  ADMIN
  SUPER_ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model Clinic {
  id              String        @id @default(cuid())
  name            String
  slug            String        @unique
  address         String
  city            String
  state           String
  pincode         String
  phone           String
  email           String
  latitude        Float
  longitude       Float
  mapEmbedUrl     String?
  description     String?
  features        String[]
  images          String[]
  workingDays     String[] // ["MON", "TUE", "WED", "THU", "FRI", "SAT"]
  startTime       String // "10:00"
  endTime         String // "19:00"
  slotDuration    Int           @default(30) // minutes
  bufferTime      Int           @default(0) // minutes between appointments
  timezone        String        @default("Asia/Kolkata")
  isActive        Boolean       @default(true)
  displayOrder    Int           @default(0)
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  appointments Appointment[]
  blockedDates BlockedDate[]

  @@index([slug])
  @@index([isActive])
}

model Appointment {
  id              String            @id @default(cuid())
  patientId       String
  patient         User              @relation(fields: [patientId], references: [id], onDelete: Cascade)
  clinicId        String
  clinic          Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  appointmentType AppointmentType
  startTime       DateTime
  endTime         DateTime
  status          AppointmentStatus @default(PENDING)
  reason          String?
  symptoms        String?
  notes           String?
  adminNotes      String?
  paymentStatus   PaymentStatus     @default(PENDING)
  paymentAmount   Float?
  paymentId       String?           @unique
  reminderSent24h Boolean           @default(false)
  reminderSent2h  Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  prescriptions Prescription[]

  @@index([patientId])
  @@index([clinicId, startTime])
  @@index([status])
}

enum AppointmentType {
  FIRST_CONSULTATION
  FOLLOW_UP
  ONLINE_CONSULTATION
  EMERGENCY
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

model BlockedDate {
  id        String   @id @default(cuid())
  clinicId  String
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  date      DateTime
  isFullDay Boolean  @default(true)
  startTime String? // For partial day blocks
  endTime   String?
  reason    String
  createdAt DateTime @default(now())

  @@index([clinicId, date])
}

model Prescription {
  id            String       @id @default(cuid())
  appointmentId String
  appointment   Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patientId     String
  patient       User         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  diagnosis     String
  medicines     Json // [{name, dosage, duration, instructions}]
  instructions  String?
  followUpDate  DateTime?
  pdfUrl        String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([patientId])
  @@index([appointmentId])
}

model MedicalReport {
  id         String   @id @default(cuid())
  patientId  String
  patient    User     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  title      String
  fileUrl    String
  fileType   String
  fileSize   Int
  uploadedAt DateTime @default(now())

  @@index([patientId])
}

model Notification {
  id            String           @id @default(cuid())
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  title         String
  message       String
  type          NotificationType
  scheduledFor  DateTime?
  sentAt        DateTime?
  isRead        Boolean          @default(false)
  appointmentId String?
  actionUrl     String?
  createdAt     DateTime         @default(now())

  @@index([userId, isRead])
}

enum NotificationType {
  APPOINTMENT_CONFIRMATION
  APPOINTMENT_REMINDER_24H
  APPOINTMENT_REMINDER_2H
  PRESCRIPTION_READY
  HEALTH_TIP
  CLINIC_UPDATE
  APPOINTMENT_CANCELLED
}

model BlogPost {
  id              String       @id @default(cuid())
  title           String
  slug            String       @unique
  excerpt         String
  content         String       @db.Text
  featuredImage   String?
  category        BlogCategory
  tags            String[]
  author          String       @default("Dr. Anshita Singh Rathore")
  authorAvatar    String?
  readingTime     Int // minutes
  views           Int          @default(0)
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  status          PostStatus   @default(DRAFT)
  publishedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([slug])
  @@index([status, publishedAt])
  @@index([category])
}

enum BlogCategory {
  TREATMENT_GUIDES
  HOMEOPATHY_BASICS
  LIFESTYLE_TIPS
  PATIENT_STORIES
  HEALTH_NEWS
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model ChatMessage {
  id        String      @id @default(cuid())
  userId    String?
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionId String
  role      MessageRole
  content   String      @db.Text
  metadata  Json?
  createdAt DateTime    @default(now())

  @@index([userId])
  @@index([sessionId])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model Testimonial {
  id          String   @id @default(cuid())
  patientName String
  patientAge  Int?
  condition   String
  testimonial String   @db.Text
  rating      Int      @default(5)
  image       String?
  isApproved  Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([isApproved, isFeatured])
}

model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String   @db.Text
  category  String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([category, order])
}
